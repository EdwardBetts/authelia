import{Z as E,m as x,r as a,j as n,l as I,au as w,R as F}from"./index.2cf54ca8.js";import{F as p}from"./components.FailureIcon.9f6e5683.js";import{F as A}from"./components.TimerIcon.f2cea1d7.js";import{a as b,W as t,L as j,c as C,e as v,h as L,i as W,p as D}from"./hooks.Timer.6169e1b2.js";import{I as k}from"./portal.IconWithContext.303a88e9.js";import{B,b as N}from"./mui.Toolbar.c29f3336.js";import{u as M}from"./hooks.Mounted.ac24f621.js";import{u as O}from"./hooks.Workflow.6e7bd503.js";import{S,D as P}from"./portal.MethodContainer.1b18e563.js";import"./portal.Authenticated.aec66e93.js";import"./index.8057fcfb.js";const H=function(e){const r=E(),[u,o,l]=b(30*1e3-500),s=x(h=>({icon:{display:"inline-block"},progressBar:{marginTop:h.spacing()}}))(),f=()=>{l(),o(),e.onRetryClick()};a.useEffect(()=>{o()},[o]);const g=n.jsx(k,{icon:n.jsx(A,{size:64,animated:!0,strong:!0}),className:e.webauthnTouchState===t.WaitTouch?void 0:"hidden",children:n.jsx(j,{value:u,className:s.progressBar,height:r.spacing(2)})}),i=n.jsx(k,{icon:n.jsx(p,{}),className:e.webauthnTouchState===t.Failure?void 0:"hidden",children:n.jsx(B,{color:"secondary",onClick:f,children:"Retry"})});return n.jsxs(N,{className:s.icon,sx:{minHeight:101},children:[g,i]})},X=function(e){const[R,r]=a.useState(t.WaitTouch),u=I(F),[o,l]=O(),s=M(),{onSignInSuccess:f,onSignInError:g}=e,i=a.useRef(g).current,h=a.useRef(f).current,T=a.useCallback(async()=>{if(!(!e.registered||e.authenticationLevel===w.TwoFactor))try{r(t.WaitTouch);const c=await C();if(c.status!==200||c.options==null){r(t.Failure),i(new Error("Failed to initiate security key sign in process"));return}const d=await v(c.options);if(d.result!==L.Success){if(!s.current)return;r(t.Failure),i(new Error(W(d.result)));return}if(d.response==null){i(new Error("The browser did not respond with the expected attestation data.")),r(t.Failure);return}if(!s.current)return;r(t.InProgress);const m=await D(d.response,u,o,l);if(m.data.status==="OK"&&m.status===200){h(m.data.data?m.data.data.redirect:void 0);return}if(!s.current)return;i(new Error("The server rejected the security key.")),r(t.Failure)}catch(c){if(!s.current)return;console.error(c),i(new Error("Failed to initiate security key sign in process")),r(t.Failure)}},[i,h,u,o,l,s,e.authenticationLevel,e.registered]);a.useEffect(()=>{T()},[T]);let y=S.METHOD;return e.authenticationLevel===w.TwoFactor?y=S.ALREADY_AUTHENTICATED:e.registered||(y=S.NOT_REGISTERED),n.jsx(P,{id:e.id,title:"Security Key",explanation:"Touch the token of your security key",duoSelfEnrollment:!1,registered:e.registered,state:y,onRegisterClick:e.onRegisterClick,children:n.jsx(H,{onRetryClick:T,webauthnTouchState:R})})};export{X as default};
